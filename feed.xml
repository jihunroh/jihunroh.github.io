<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.2.2">Jekyll</generator><link href="https://jihunroh.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://jihunroh.github.io/" rel="alternate" type="text/html" /><updated>2022-09-25T09:27:55-05:00</updated><id>https://jihunroh.github.io/feed.xml</id><title type="html">JiHun Roh</title><author><name>노지훈</name></author><entry><title type="html">어항 수온을 집 밖에서도 관리하기</title><link href="https://jihunroh.github.io/2022/09/24/%EC%96%B4%ED%95%AD-%EC%88%98%EC%98%A8%EC%9D%84-%EC%A7%91-%EB%B0%96%EC%97%90%EC%84%9C%EB%8F%84-%EA%B4%80%EB%A6%AC%ED%95%98%EA%B8%B0/" rel="alternate" type="text/html" title="어항 수온을 집 밖에서도 관리하기" /><published>2022-09-24T00:00:00-05:00</published><updated>2022-09-24T00:00:00-05:00</updated><id>https://jihunroh.github.io/2022/09/24/%EC%96%B4%ED%95%AD%20%EC%88%98%EC%98%A8%EC%9D%84%20%EC%A7%91%20%EB%B0%96%EC%97%90%EC%84%9C%EB%8F%84%20%EA%B4%80%EB%A6%AC%ED%95%98%EA%B8%B0</id><content type="html" xml:base="https://jihunroh.github.io/2022/09/24/%EC%96%B4%ED%95%AD-%EC%88%98%EC%98%A8%EC%9D%84-%EC%A7%91-%EB%B0%96%EC%97%90%EC%84%9C%EB%8F%84-%EA%B4%80%EB%A6%AC%ED%95%98%EA%B8%B0/"><![CDATA[<p>간만에 여유가 있어, 오래전 홀린듯이 사두었던 <a href="https://store.arduino.cc/products/arduino-uno-wifi-rev2">Arduino Uno WiFi Rev2</a> 보드로 어항 수온 센서를 만들었다. 어항 수온계는 제품이 워낙 많지만, Home Assistant  같은 IoT 플랫폼에서 데이터를 수집할 수 있는 제품은 발견치 못했다. 만들만 하다고 생각했다.</p>

<h2 id="준비물">준비물</h2>

<ul>
  <li><a href="https://store.arduino.cc/products/arduino-uno-wifi-rev2">Arduino Uno WiFi Rev2 보드</a></li>
  <li><a href="https://ko.aliexpress.com/item/4000068914916.html">DS18B20 수온측정 모듈 + 프로브</a></li>
  <li><a href="https://ko.aliexpress.com/item/32896971385.html">SSD1306 OLED 모듈</a></li>
  <li><a href="https://www.arduino.cc/en/software">Arduino IDE</a> 또는 <a href="https://platformio.org/">PlatformIO</a></li>
</ul>

<h2 id="구상">구상</h2>

<ul>
  <li>수온을 프로브로 일정주기(예: 3초)마다 측정한다.</li>
  <li>측정된 수온을 디지털 액정에 보여준다.</li>
  <li>측정된 수온을 MQTT Broker에 전달하여 Home Assistant에 표현한다.</li>
</ul>

<h2 id="수온-측정하기">수온 측정하기</h2>

<p>언제 왜 샀는지도 모르는 <code class="language-plaintext highlighter-rouge">DS18B20 모듈</code>의 제품 설명에서 풀업 저항을 달아서 쓰라 하기에, 다른 사용례를 보고 4.7kΩ의 풀업 저항을 달았다.</p>

<p><img src="/assets/images/2022/DS18B20.png" alt="DS18B20" /></p>

<p>Platform IO에서 <a href="https://www.arduino.cc/reference/en/libraries/onewire/"><code class="language-plaintext highlighter-rouge">OneWire</code></a>, <a href="https://www.arduino.cc/reference/en/libraries/dallastemperature/"><code class="language-plaintext highlighter-rouge">DallasTemperature</code></a> 라이브러리를 설치했다.
사실 알리익스프레스에서 구한 중국산이다 보니 라이브러리가 있을까 걱정했는데,
동일한 제품들의 모조품이라 그런지 라이브러리도 그대로 작동!</p>

<p>간단한 소스를 만들어 바로 물에 담가 테스트 시작.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;OneWire.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;DallasTemperature.h&gt;</span><span class="cp">
</span>
<span class="cp">#define ONE_WIRE_BUS 2
</span>
<span class="n">OneWire</span> <span class="nf">oneWire</span><span class="p">(</span><span class="n">ONE_WIRE_BUS</span><span class="p">);</span>
<span class="n">DallasTemperature</span> <span class="nf">sensors</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oneWire</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
  <span class="n">sensors</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">sensors</span><span class="p">.</span><span class="n">requestTemperatures</span><span class="p">();</span>
  <span class="kt">float</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">round</span><span class="p">(</span><span class="n">sensors</span><span class="p">.</span><span class="n">getTempCByIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>스타벅스 속의 프로브…</p>

<p><img src="/assets/images/2022/probe-in-starbucks.jpg" alt="Probe in Starbucks" /></p>

<p><img src="/assets/images/2022/arduino-plotter.jpg" alt="DS18B20" /></p>

<p>얼추 따뜻한 물과 찬물 구분이 되는걸 확인했다.
근데 <a href="https://www.hannainst.com/marine-salinity-tester-hi98319.html">아무래도 중국산이다보니 측정되는 숫자를 못 믿겠어서 믿을만한 다른 수온계와 비교측정을 했다</a>.
내가 사용할 섭씨 20~35도 구간에서 1도 정도 높게 측정되는 걸 출력값에 반영토록 보정했다.</p>

<h2 id="oled-액정에-보여주기">OLED 액정에 보여주기</h2>

<p>데이터는 장치에서 바로 보여주어야 시인성도 높다.
어디서 언제 산지 모른 <code class="language-plaintext highlighter-rouge">SSD1306 모듈</code>을 추가로 달고, <a href="https://www.arduino.cc/reference/en/libraries/adafruit-ssd1306/"><code class="language-plaintext highlighter-rouge">Adafruit SSD1306</code></a>, <a href="https://www.arduino.cc/reference/en/libraries/adafruit-gfx-library/"><code class="language-plaintext highlighter-rouge">Adafruit_GFX</code></a> 라이브러리를 추가했다.
추가되는 소스 만 보자.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;Adafruit_GFX.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Adafruit_SSD1306.h&gt;</span><span class="cp">
</span>
<span class="cp">#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET     4
#define ONE_WIRE_BUS   2
</span>
<span class="n">Adafruit_SSD1306</span> <span class="nf">display</span><span class="p">(</span><span class="n">SCREEN_WIDTH</span><span class="p">,</span> <span class="n">SCREEN_HEIGHT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Wire</span><span class="p">,</span> <span class="n">OLED_RESET</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">display</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">SSD1306_SWITCHCAPVCC</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">);</span>
  <span class="n">display</span><span class="p">.</span><span class="n">clearDisplay</span><span class="p">();</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">loop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">display</span><span class="p">.</span><span class="n">clearDisplay</span><span class="p">();</span>
  <span class="n">display</span><span class="p">.</span><span class="n">setTextSize</span><span class="p">(</span><span class="mf">1.5</span><span class="p">);</span>
  <span class="n">display</span><span class="p">.</span><span class="n">setTextColor</span><span class="p">(</span><span class="n">WHITE</span><span class="p">);</span>
  <span class="n">display</span><span class="p">.</span><span class="n">setCursor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">28</span><span class="p">);</span>
  <span class="n">display</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Temperature: "</span> <span class="o">+</span> <span class="n">String</span><span class="p">(</span><span class="n">temp</span><span class="p">));</span>
  <span class="n">display</span><span class="p">.</span><span class="n">display</span><span class="p">();</span>

  <span class="n">delay</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>점점 모양을 갖춰간다. 이제 컴퓨터에 연결하여 시리얼 모니터를 볼 필요 없이 OLED 액정을 보면 된다.
3초마다 측정된 온도가 나타난다. 추후 다른 센서 모듈을 추가하면 계기판처럼 쓸 수도 있겠다.</p>

<p><img src="/assets/images/2022/SSD1306.jpg" alt="SSD1306" /></p>

<h2 id="wi-fi에-연결하자">Wi-Fi에 연결하자</h2>

<p><a href="https://www.arduino.cc/reference/en/libraries/wifinina/"><code class="language-plaintext highlighter-rouge">WiFiNINA</code></a> 라이브러리를 추가했다.
펌웨어 업데이트 중 실수로 보드 WiFi 모듈이 벽돌이 되어버렸다.
많이 해맸는데 <a href="https://arduino.github.io/arduino-fwuploader/1.0/commands/arduino-fwuploader_firmware_flash/">커맨드라인 툴로 업데이트하면서 해결됐다.</a>
Arduino Uno WiFi Rev2의 보드명은 <code class="language-plaintext highlighter-rouge">arduino:megaavr:uno2018</code>이다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./arduino-fwuploader firmware flash <span class="nt">-b</span> arduino:megaavr:uno2018 <span class="nt">-a</span> COM3
</code></pre></div></div>

<p>추가될 부분만 살펴보자.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;SPI.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;WiFiNINA.h&gt;</span><span class="cp">
</span>
<span class="cp">#define WIFI_SSID     "&lt;Wi-Fi 네트워크 SSID 이름&gt;"
#define WIFI_PASSWORD "&lt;Wi-Fi 네트워크 비밀번호&gt;"
</span>
<span class="n">WiFiClient</span>        <span class="n">client</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>

  <span class="k">while</span> <span class="p">(</span><span class="n">WiFi</span><span class="p">.</span><span class="n">status</span><span class="p">()</span> <span class="o">!=</span> <span class="n">WL_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"."</span><span class="p">);</span>
      <span class="n">WiFi</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">WIFI_SSID</span><span class="p">,</span> <span class="n">WIFI_PASSWORD</span><span class="p">);</span>
      <span class="n">delay</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Connected to the Wi-Fi network"</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<h2 id="mqtt-broker에-메시지를-보내자">MQTT Broker에 메시지를 보내자</h2>

<p>Home Assistant가 인식할 수 있는 MQTT 메시지 포맷을 쉽게 구성해주는 라이브러리가 있을 것 같았다.
바퀴를 다시 발명할 필요 없다. 검색된 라이브러리 중 사용법이 간단한 <a href="https://www.arduino.cc/reference/en/libraries/home-assistant-integration/"><code class="language-plaintext highlighter-rouge">home-assistant-integration</code></a>를 선택했다.</p>

<p><img src="/assets/images/2022/home_assistant_library.png" alt="Home Assistant 관련 라이브러리" /></p>

<p>예외처리를 만들고 프로그램 완결성을 높였다.
이름은 거창하게 <code class="language-plaintext highlighter-rouge">Reef Sense</code>로 지었다.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;OneWire.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;WiFiNINA.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;DallasTemperature.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Adafruit_GFX.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Adafruit_SSD1306.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;ArduinoHA.h&gt;</span><span class="cp">
</span>
<span class="cp">#define ONE_WIRE_BUS 2
</span>
<span class="cp">#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET     4
#define ONE_WIRE_BUS   2
</span>
<span class="cp">#define BROKER_ADDR         IPAddress(192,168,&lt;IP&gt;,&lt;주소&gt;)
#define BROKER_USERNAME     "&lt;MQTT BROKER USERNAME&gt;"
#define BROKER_PASSWORD     "&lt;MQTT BROKER PASSWORD&gt;"
</span>
<span class="cp">#define WIFI_SSID     "&lt;Wi-Fi 네트워크 SSID 이름&gt;"
#define WIFI_PASSWORD "&lt;Wi-Fi 네트워크 비밀번호&gt;"
</span>
<span class="cp">#define VERSION "2022.9.25"
</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lastSentAt</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
<span class="n">byte</span> <span class="n">mac</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="s">"&lt;MAC&gt;"</span><span class="p">,</span> <span class="s">"&lt;주소&gt;"</span><span class="p">,</span> <span class="s">"&lt;16진수로&gt;"</span><span class="p">,</span> <span class="s">"&lt;넣기&gt;"</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>

<span class="n">OneWire</span> <span class="n">oneWire</span><span class="p">(</span><span class="n">ONE_WIRE_BUS</span><span class="p">);</span>
<span class="n">DallasTemperature</span> <span class="n">sensors</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oneWire</span><span class="p">);</span>
<span class="n">Adafruit_SSD1306</span> <span class="n">display</span><span class="p">(</span><span class="n">SCREEN_WIDTH</span><span class="p">,</span> <span class="n">SCREEN_HEIGHT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Wire</span><span class="p">,</span> <span class="n">OLED_RESET</span><span class="p">);</span>
<span class="n">WiFiClient</span> <span class="n">client</span><span class="p">;</span>
<span class="n">HADevice</span> <span class="n">device</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mac</span><span class="p">));</span>
<span class="n">HAMqtt</span> <span class="n">mqtt</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
<span class="n">HASensor</span> <span class="n">temperature_sensor</span><span class="p">(</span><span class="s">"reefer_temperature"</span><span class="p">);</span>

<span class="kt">float</span> <span class="n">measure_temperature</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">sensors</span><span class="p">.</span><span class="n">requestTemperatures</span><span class="p">();</span>
  <span class="kt">float</span> <span class="n">temperature</span> <span class="o">=</span> <span class="p">(</span><span class="n">round</span><span class="p">(</span><span class="n">sensors</span><span class="p">.</span><span class="n">getTempCByIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">temperature</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">print_display</span><span class="p">(</span><span class="kt">float</span> <span class="n">temperature</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">display</span><span class="p">.</span><span class="n">clearDisplay</span><span class="p">();</span>
  <span class="n">display</span><span class="p">.</span><span class="n">setTextSize</span><span class="p">(</span><span class="mf">1.5</span><span class="p">);</span>
  <span class="n">display</span><span class="p">.</span><span class="n">setCursor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">display</span><span class="p">.</span><span class="n">setTextColor</span><span class="p">(</span><span class="n">WHITE</span><span class="p">);</span>
  
  <span class="n">display</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"Temperature: "</span><span class="p">);</span>
  <span class="n">display</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">temperature</span><span class="p">);</span>
  <span class="n">display</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">WiFi</span><span class="p">.</span><span class="n">status</span><span class="p">()</span> <span class="o">==</span> <span class="n">WL_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">display</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Wi-Fi:   Connected"</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">display</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Wi-Fi:   Disconnected"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">mqtt</span><span class="p">.</span><span class="n">isConnected</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">display</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"MQTT:    Connected"</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">display</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"MQTT:    Disconnected"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">display</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"Version: "</span><span class="p">);</span>
  <span class="n">display</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">VERSION</span><span class="p">);</span>

  <span class="n">display</span><span class="p">.</span><span class="n">display</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"[0] Serial Initiated..."</span><span class="p">);</span>
  
  <span class="n">sensors</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="n">temperature_sensor</span><span class="p">.</span><span class="n">setName</span><span class="p">(</span><span class="s">"Reefer Temperature"</span><span class="p">);</span>
  <span class="n">temperature_sensor</span><span class="p">.</span><span class="n">setDeviceClass</span><span class="p">(</span><span class="s">"temperature"</span><span class="p">);</span>
  <span class="n">temperature_sensor</span><span class="p">.</span><span class="n">setUnitOfMeasurement</span><span class="p">(</span><span class="s">"℃"</span><span class="p">);</span>
  <span class="n">temperature_sensor</span><span class="p">.</span><span class="n">setIcon</span><span class="p">(</span><span class="s">"mdi:water-thermometer"</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"[1] Sensor Initiated..."</span><span class="p">);</span>

  <span class="n">display</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">SSD1306_SWITCHCAPVCC</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">);</span>
  <span class="n">display</span><span class="p">.</span><span class="n">clearDisplay</span><span class="p">();</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"[2] Display Initiated..."</span><span class="p">);</span>

  <span class="k">while</span> <span class="p">(</span><span class="n">WiFi</span><span class="p">.</span><span class="n">status</span><span class="p">()</span> <span class="o">!=</span> <span class="n">WL_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"[3] Wi-fi Failed to connect..."</span><span class="p">);</span>
    <span class="n">WiFi</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">WIFI_SSID</span><span class="p">,</span> <span class="n">WIFI_PASSWORD</span><span class="p">);</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"[3] Wi-Fi Connected..."</span><span class="p">);</span>

  <span class="n">device</span><span class="p">.</span><span class="n">setName</span><span class="p">(</span><span class="s">"Arduino Reef Sense"</span><span class="p">);</span>
  <span class="n">device</span><span class="p">.</span><span class="n">setSoftwareVersion</span><span class="p">(</span><span class="n">VERSION</span><span class="p">);</span>
  <span class="n">device</span><span class="p">.</span><span class="n">setModel</span><span class="p">(</span><span class="s">"Arduino Uno WiFi Rev2"</span><span class="p">);</span>
  <span class="n">device</span><span class="p">.</span><span class="n">setManufacturer</span><span class="p">(</span><span class="s">"Jihun Roh"</span><span class="p">);</span>

  <span class="n">mqtt</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">BROKER_ADDR</span><span class="p">,</span> <span class="n">BROKER_USERNAME</span><span class="p">,</span> <span class="n">BROKER_PASSWORD</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"[4] MQTT Connected..."</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">sensors</span><span class="p">.</span><span class="n">requestTemperatures</span><span class="p">();</span>
  <span class="kt">float</span> <span class="n">temperature</span> <span class="o">=</span> <span class="n">measure_temperature</span><span class="p">();</span>
  <span class="n">print_display</span><span class="p">(</span><span class="n">temperature</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">((</span><span class="n">millis</span><span class="p">()</span> <span class="o">-</span> <span class="n">lastSentAt</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">lastSentAt</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
    <span class="n">temperature_sensor</span><span class="p">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">temperature</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">mqtt</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>최종 작동 모습이다. 주말 틈틈히 작업한 보람이 LED에 보인다.
LED에는 수온 뿐만 아니라 Wi-Fi 연결, MQTT 연결이 잘 되었는지도 표현되게 하였다.</p>

<p><img src="/assets/images/2022/reef_sense.jpg" alt="최종 작동모습" /></p>

<p>이렇게 준비한 이른바 <code class="language-plaintext highlighter-rouge">Reef Sense</code>를 어항 밑 섬프항에 놓아두었다.
프로브는 히터나 모터 등 열을 발산하는 곳으로부터 멀리 두어야 신뢰할만한 값을 측정할 수 있다.
나는 본수조로부터 섬프항으로 내려오는 파이프 앞에 프로브를 두었다.</p>

<p><img src="/assets/images/2022/reef_sense_in_real_world.jpg" alt="실제 장착모습" /></p>

<p>Home Assistant에 UI를 달았다. 아직 기본적인 UI지만, 사용성이 높게 수정해나가야 한다.</p>

<p><img src="/assets/images/2022/home_assistant_lovelace.png" alt="Home Assistant Lovelace 모습" /></p>

<h2 id="tbd">TBD</h2>

<ul>
  <li>빵판에 주렁주렁 달아놓은 전선을 적절한 박스로 포장한다.</li>
  <li>집에 PH 센서와 프로브 남는 것이 있는데 이것도 달아야 겠다.</li>
  <li>용존산소 등 다른 센서도 알아본다.</li>
  <li>UI를 더 직관적이고 이쁘게 꾸민다.</li>
  <li>겨울철을 앞두고 이 값을 기반으로 수온이 적정범위를 벗어났을 때, 알림을 뜨도록 하고 여유 히터를 작동토록 하는 자동화를 만들 생각이다.</li>
</ul>]]></content><author><name>노지훈</name></author><category term="IoT" /><category term="Reef" /><summary type="html"><![CDATA[간만에 여유가 있어, 오래전 홀린듯이 사두었던 Arduino Uno WiFi Rev2 보드로 어항 수온 센서를 만들었다. 어항 수온계는 제품이 워낙 많지만, Home Assistant 같은 IoT 플랫폼에서 데이터를 수집할 수 있는 제품은 발견치 못했다. 만들만 하다고 생각했다.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jihunroh.github.io/assets/images/2022/reef_sense.jpg" /><media:content medium="image" url="https://jihunroh.github.io/assets/images/2022/reef_sense.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">이산화탄소 절대음감(?)의 실내공기 관리</title><link href="https://jihunroh.github.io/2022/09/11/%EC%9D%B4%EC%82%B0%ED%99%94%ED%83%84%EC%86%8C-%EC%A0%88%EB%8C%80%EC%9D%8C%EA%B0%90%EC%9D%98-%EC%8B%A4%EB%82%B4%EA%B3%B5%EA%B8%B0-%EA%B4%80%EB%A6%AC/" rel="alternate" type="text/html" title="이산화탄소 절대음감(?)의 실내공기 관리" /><published>2022-09-11T00:00:00-05:00</published><updated>2022-09-11T00:00:00-05:00</updated><id>https://jihunroh.github.io/2022/09/11/%EC%9D%B4%EC%82%B0%ED%99%94%ED%83%84%EC%86%8C%20%EC%A0%88%EB%8C%80%EC%9D%8C%EA%B0%90%EC%9D%98%20%EC%8B%A4%EB%82%B4%EA%B3%B5%EA%B8%B0%20%EA%B4%80%EB%A6%AC</id><content type="html" xml:base="https://jihunroh.github.io/2022/09/11/%EC%9D%B4%EC%82%B0%ED%99%94%ED%83%84%EC%86%8C-%EC%A0%88%EB%8C%80%EC%9D%8C%EA%B0%90%EC%9D%98-%EC%8B%A4%EB%82%B4%EA%B3%B5%EA%B8%B0-%EA%B4%80%EB%A6%AC/"><![CDATA[<h2 id="가혹한-공기질-환경">가혹한 공기질 환경</h2>

<p>쾌적한 실내 공기질을 유지하려 한다면 어떤 변수에 신경써야나?
실내 공기질을 말할 때 많이 언급하는 변수가 5개는 되는 것 같다.</p>

<ul>
  <li>기온</li>
  <li>습도</li>
  <li>이산화탄소 농도</li>
  <li>VOC(휘발성 유기화합물) 농도</li>
  <li>PM (미세먼지) 농도</li>
</ul>

<p>한국에서 우리 공기질 환경은 충분히 가혹하다.
겨울은 너무 춥고 건조해서 아침마다 코피가 난다. 여름에는 콧속 사이사이를 더운 증기가 채우는 느낌이다.
사시사철 문제도 있다. 대여섯시간 동안 환기를 안하면 끕끕하고 퀘퀘한 느낌을 참기 어렵다.
환기했더니 오히려 미세먼지가 유입되는 경우도 많다.</p>

<h2 id="iot를-시작하는-이유">IoT를 시작하는 이유</h2>

<p>여기서 시작된다. 이런 질문을 스스로 하고 있다면 당신은 IoT의 피가 온몸에 흐르고 있다.</p>

<ul>
  <li>덥다는 느낌이 들고서야 사후적으로 에어컨을 켜거나 목표온도를 낮추는 건, 어쩐지 4차 산업혁명 시대에 사는 느낌이 아니다.</li>
  <li>리모컨을 찾기 귀찮다!</li>
  <li>실내 기온을 느끼고 에어컨을 조작하는 하찮은 행동따위에 내 고도의 지성을 쓸 시간이 아깝다</li>
  <li>난 과학을 믿는다, 이 모든 걸 과학적으로 할 수 있다고 생각한다!</li>
</ul>

<p>NASA는 <code class="language-plaintext highlighter-rouge">인간은 비선형처리가 가능한 가장 값싼 컴퓨터 시스템</code>이라고 했다.
우린 온도가 27도가 넘을 때 리모컨으로 에어컨 제습기능을 켜고,
미세먼지 농도가 높으면 공기청정기을 켜면 된다.</p>

<p>그런데 NASA도 인정하는 가장 값싼 비선형처리 컴퓨터 시스템이 이런 선형적이고 일상적인 일을 하고 있는게 이해되지 않을 때
비로소 IoT를 필요로 하게 된다.</p>

<h2 id="그럼-측정과-저장부터">그럼 측정과 저장부터…</h2>

<p>우리집은 방마다 <a href="https://www.getawair.com/products/element">Awair Element</a>를 설치해놓았다(내돈내산).
출시된지 2년쯤 되었지만 인테리어 템이 될 정도로 만듦새가 좋아서 세간에서 여전히 인기가 많다.
인기만큼 가격은 덤, 현재 가격은 개당 $299달러다.
처음 샀을 때보다 가격이 50% 이상 오른 듯.</p>

<p><img src="/assets/images/2022/awair_element_1.jpg" alt="거실 Awair Element" /></p>

<p><img src="/assets/images/2022/awair_element_2.jpg" alt="서재 Awair Element" /></p>

<p>이 측정기는 이쁠 뿐만 아니라 플랫폼이 제법 다재다능한데,
측정한 공기질을 서버에 저장하고 <a href="https://play.google.com/store/apps/details?id=co.bitfinder.awair&amp;hl=ko&amp;gl=US">모바일앱</a>으로 보여준다.
일반 사용자라면 모바일앱을 쓰면서 손수 환기를 하건, 공기청정기나 에어컨, 제습기 따위를 조작하면 된다.</p>

<p><img src="/assets/images/2022/awair_app.webp" alt="Awair Mobile App" /></p>

<p>데이터 수집은 필수적이다.
<a href="https://support.getawair.com/hc/en-us/articles/360049221014-Awair-Element-Local-API-Feature">Awair는 친절하게도 API를 제공하기에</a>,
나는 우리집 Home Assistant 플랫폼에 데이터를 끌여들일 수 있었다.
이렇게 간단한 <code class="language-plaintext highlighter-rouge">YAML</code> 코드로 Awair Element가 수집하고 있는 데이터를 내 Home Assistant 시스템에도 저장할 수 있다.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">sensor</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">rest</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">거실 어웨어</span>
    <span class="na">json_attributes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">temp</span>
      <span class="pi">-</span> <span class="s">humid</span>
      <span class="pi">-</span> <span class="s">co2</span>
      <span class="pi">-</span> <span class="s">voc</span>
      <span class="pi">-</span> <span class="s">pm25</span>
    <span class="na">resource</span><span class="pi">:</span> <span class="s">Awair의 로컬 IP 주소</span>
    <span class="na">value_template</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
    <span class="na">scan_interval</span><span class="pi">:</span> <span class="m">60</span>
</code></pre></div></div>

<p>데이터는 Home Asssistant의 데이터베이스에 14일간 저장해놓고 있다.
이 데이터는 Home Assistant에서 다양한 방법으로 나타낼 수 있지만, <a href="https://github.com/kalkih/mini-graph-card">Mini Graph Card</a>를 이용해 현재값과 트렌드를 간략히 보여주도록 했다.
기온과 습도로 <a href="https://ko.wikipedia.org/wiki/%EB%B6%88%EC%BE%8C%EC%A7%80%EC%88%98">불쾌지수</a> 계산도 가능하다.</p>

<p><img src="/assets/images/2022/awiar_sensing.webp" alt="Awair 측정결과" /></p>

<h2 id="문제-해결을-위한-자동화">문제 해결을 위한 자동화…</h2>

<p>이 데이터로 실내 이산화탄소 농도가 700ppm보다 높아지면 전열교환기를 작동하도록 하고 있다.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">automation</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">alias</span><span class="pi">:</span> <span class="s">전열교환기 켜기 자동화</span>
    <span class="na">trigger</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">numeric_state</span>
        <span class="na">above</span><span class="pi">:</span> <span class="s1">'</span><span class="s">700'</span>
        <span class="na">entity_id</span><span class="pi">:</span> <span class="s">sensor.geosil_co2</span>
    <span class="na">action</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">service</span><span class="pi">:</span> <span class="s">fan.turn_on</span>
        <span class="na">entity_id</span><span class="pi">:</span> <span class="s">fan.jeonyeolgyohwangi</span>
    <span class="na">mode</span><span class="pi">:</span> <span class="s">single</span>
</code></pre></div></div>

<p>우리집에서는 집에 사람이 있는지, 겨울철이라 전열교환 기능을 쓸지 말지 등에 따라,
위 스크립트를 변용해서 쓰고 있다.</p>

<p>그럼 전열교환기는 언제 멈추는가?
trigger에 따라 다양한 방법으로 구현할 수 있는데,
난 전열교환기가 켜지면 자동화 스크립트가 시작되어 이산화탄소 농도가 600ppm보다 낮아질 때까지 작동하도록 하고 있다.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">automation</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">alias</span><span class="pi">:</span> <span class="s">전열교환기 끄기 자동화</span>
    <span class="na">trigger</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">state</span>
        <span class="na">entity_id</span><span class="pi">:</span> <span class="s">fan.jeonyeolgyohwangi</span>
        <span class="na">from</span><span class="pi">:</span> <span class="s1">'</span><span class="s">off'</span>
        <span class="na">to</span><span class="pi">:</span> <span class="s1">'</span><span class="s">on'</span>
    <span class="na">action</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">wait_template</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">states('sensor.average_co2')</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">float</span><span class="nv"> </span><span class="s">&lt;</span><span class="nv"> </span><span class="s">600</span><span class="nv"> </span><span class="s">}}"</span>
      <span class="pi">-</span> <span class="na">service</span><span class="pi">:</span> <span class="s">fan.turn_off</span>
        <span class="na">entity_id</span><span class="pi">:</span> <span class="s">fan.jeonyeolgyohwangi</span>
    <span class="na">mode</span><span class="pi">:</span> <span class="s">restart</span>
</code></pre></div></div>

<p>이게 가장 간단한 자동화다. 위 코드 밑에는 RS485로 통신하는 전열교환기의 패킷을 납치하여 조작하는 것, Awair Element의 데이터를 REST로 가져오는 것 등이 숨어있지만,
기본 흐름을 보여주기에는 충분한 것 같다.</p>

<p>그리고 실제로 이 자동화 스크립트는 전열교환기 만으로 이산화탄소 농도 저감이 가능하다는 가정을 하고 있다.
집 안에서 이산화탄소 탄소를 내뿜는 사람이 많다면, 전열교환기로 아무리 환기를 한들, 이산화탄소 평형점은 올라갈 수 밖에 없다.</p>

<p>이러한 평형점이 쾌쾌한 공기라는 게 느껴질 정도인 1,000ppm을 넘는다면?
이 때는 전열교환기가 아니라, 창문 자동개폐기를 써야 한다.</p>]]></content><author><name>노지훈</name></author><category term="IoT" /><summary type="html"><![CDATA[가혹한 공기질 환경]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jihunroh.github.io/assets/images/2022/awair_app.webp" /><media:content medium="image" url="https://jihunroh.github.io/assets/images/2022/awair_app.webp" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">우리집 IoT를 인프라부터 소개합니다</title><link href="https://jihunroh.github.io/2022/08/07/%EB%82%B4-%ED%99%88-IoT%EB%A5%BC-%EC%86%8C%EA%B0%9C%ED%95%A9%EB%8B%88%EB%8B%A4/" rel="alternate" type="text/html" title="우리집 IoT를 인프라부터 소개합니다" /><published>2022-08-07T00:00:00-05:00</published><updated>2022-08-07T00:00:00-05:00</updated><id>https://jihunroh.github.io/2022/08/07/%EB%82%B4%20%ED%99%88%20IoT%EB%A5%BC%20%EC%86%8C%EA%B0%9C%ED%95%A9%EB%8B%88%EB%8B%A4</id><content type="html" xml:base="https://jihunroh.github.io/2022/08/07/%EB%82%B4-%ED%99%88-IoT%EB%A5%BC-%EC%86%8C%EA%B0%9C%ED%95%A9%EB%8B%88%EB%8B%A4/"><![CDATA[<p>근 3년간 집에서 갈고닦아 쓰고 있는 IoT 환경을 소개한다.</p>

<h2 id="시스템-intel-nuc--manjaro-linux">시스템: <a href="https://www.intel.co.kr/content/www/kr/ko/products/sku/214624/intel-nuc-kit-nuc7cjyhn/specifications.html">Intel NUC</a> + <a href="https://manjaro.org/">Manjaro Linux</a></h2>

<p>2019년부터 ARM 기반의 Raspberrypi를 쓰다가, 2022년 초부터 AMD64 기반의 Intel NUC(NUC7CJYHN)를 쓰고 있다.
Raspberrypi OS, Ubuntu도 오래 썼지만, Manjaro Linux에 만족스럽게 정착 중이다.</p>

<p><img src="/assets/images/nairobi.webp" alt="Nairobi 모습" />
<em>물론 서버는 와이프가 보지 못하게 소파 뒤에 숨겨놓고 쓴다.</em></p>

<h2 id="iot-플랫폼-home-assistant">IoT 플랫폼: <a href="https://www.home-assistant.io/">Home Assistant</a></h2>

<p>인기 많은 <a href="https://www.smartthings.com/">Smartthings</a>를 3개월 정도 쓰다가,
문자 기반 인터페이스(CUI)가 성격에 맞았기에 <a href="https://www.home-assistant.io/">Home Assistant</a>로 전향했다.</p>

<p><a href="https://github.com/jihunroh/homeassistant-configuration">우리집 IoT 시스템의 작동 코드를 GitHub에서 관리하고 있다.</a>
그간 오랜 누더기질 덕분에 2022.8월초 현재 코드줄 수는 7천줄에 이른다. <del>배보다 배꼽이 더…</del></p>

<p><img src="/assets/images/homeassistant-integration.webp" alt="Home Assistant Integration 모습" />
<em>집에서 Home Assistant로 사용 중인 확장</em></p>

<h2 id="통신방식-zigbee-80--others-20">통신방식: Zigbee 80% + Others 20%</h2>

<p>사물이 허브와 통신하는 방식은 ZigBee, Z-Wave, Wi-Fi, Bluetooth, RF 등이 있다.
<del>상황에 따라 통신 방식을 선택해야 한다.</del>
IoT 하는 여는 사람들처럼 저전력이고 네트워크 부하가 적은 ZigBee를 좋아하지만, 마음에 드는 사물의 통신방식을 받아들일 수 밖에 없다.</p>

<p>내가 쓰는 사물 대부분이 ZigBee로 허브와 통신한다.
Zigbee 네트워크를 구성하기 위한 게이트웨이로 CC2538을 연결했다.
<a href="https://www.zigbee2mqtt.io/information/supported_adapters.html">CC2531, CC2538, Conbee 등 다른 선택지도 많고 성능 차이가 있다.</a></p>

<p><img src="/assets/images/cc2538.webp" alt="CC2538 연결 모습" />
<em>CC2538을 Intel NUC에 연결한 모습</em></p>

<p>Wi-Fi 기반 사물은 Awair 공기질 측정기나 Xiaomi 로봇청소기 같이 API를 제공하고 있는 경우만 제한적으로 쓰고 있다.
마찬가지로 Bluetooth 기반 사물로 SwitchBot을 써서 커피머신에 붙여쓰고 있다.
SwitchBot은 Home Assistant가 빌트인으로 지원하고 있다.</p>

<p><a href="http://127.0.0.1:4000/2020/10/03/월패드-원격제어를-위한-RS485-패킷-분석-준비/">RS485 방식으로 통신하는 월패드는 월패드 뒷면을 따서 패킷을 훔쳐쓰고 있다.</a>
RS485 패킷과 TCP/IP 소켓 통신간 어댑터인 Elfin EW11을 이용하고 있다.
패킷을 감청하면, 예컨대 월패드로 난방을 켰을 때 어떤 신호가 오가는지를 캡춰할 수 있게 된다.
그래서 내가 원할 때 같은 신호를 RS485에 흘려주면 난방을 킬 수 있다.
<a href="https://github.com/jihunroh/rs485_2mqtt">직접 해석한 패킷을 Home Assistant에서 조작할 수 있도록 별도 프로그램을 작성해서 쓰고 있다</a>.</p>

<h2 id="하고있는-것">하고있는 것</h2>

<p>IoT가 뭔지 모르는 와이프도 별도로 사용법을 알 필요 없이 작동하는 자동화를 지향하고 있다.
<a href="https://github.com/jihunroh/homeassistant-configuration/tree/master/automations">Github 저장소에서 내가 쓰고 있는 자동화를 확인할 수 있다.</a>
약 70개에 가까운 자동화 코드를 쓰고 있는데, 시간이 될 때 소개해보려 한다.</p>]]></content><author><name>노지훈</name></author><category term="IoT" /><summary type="html"><![CDATA[근 3년간 집에서 갈고닦아 쓰고 있는 IoT 환경을 소개한다.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jihunroh.github.io/assets/images/covers/iot.jpg" /><media:content medium="image" url="https://jihunroh.github.io/assets/images/covers/iot.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">내가 글을 웹에 올리는 방법은?</title><link href="https://jihunroh.github.io/2022/07/10/%EB%82%B4%EA%B0%80-%EA%B8%80%EC%9D%84-%EC%9B%B9%EC%97%90-%EC%98%AC%EB%A6%AC%EB%8A%94-%EB%B0%A9%EB%B2%95%EC%9D%80/" rel="alternate" type="text/html" title="내가 글을 웹에 올리는 방법은?" /><published>2022-07-10T00:00:00-05:00</published><updated>2022-07-10T00:00:00-05:00</updated><id>https://jihunroh.github.io/2022/07/10/%EB%82%B4%EA%B0%80%20%EA%B8%80%EC%9D%84%20%EC%9B%B9%EC%97%90%20%EC%98%AC%EB%A6%AC%EB%8A%94%20%EB%B0%A9%EB%B2%95%EC%9D%80</id><content type="html" xml:base="https://jihunroh.github.io/2022/07/10/%EB%82%B4%EA%B0%80-%EA%B8%80%EC%9D%84-%EC%9B%B9%EC%97%90-%EC%98%AC%EB%A6%AC%EB%8A%94-%EB%B0%A9%EB%B2%95%EC%9D%80/"><![CDATA[<p>이 웹사이트는 Ruby 기반인 Jekyll로 만들었다.
개발자들이 많이 써온 프로그램인데, 2014년부터 써왔더니 나도 제법 쓸줄 안다.
next.js 같은 더 현대적인 프로그램들이 각광받는 요즘에도,
오히려 투박해서 매력적인 프로그램이다.</p>

<p>이 프로그램을 쓰는 방법은 개발자에겐 쉽겠지만 나한테 그렇지 않았다.
수많은 시행착오를 거쳐서야, 내게 가장 최적인 방식을 찾게 됐다.</p>

<p>간만에 GitHub를 둘러보다가, 수년 전 한참 애먹었던 Continuous Integration이
Actions이라는 이름으로 서비스화되어 있었다. 주말에 장난감처럼 빠져 놀았다.</p>

<h2 id="환경-만들기">환경 만들기</h2>

<p><a href="https://jekyllrb.com/docs/installation/windows/#installation-via-bash-on-windows-10">Windows Subsystem for Linux에 Jekyll을 이용하는 환경을 만든다.</a>
집에 다용도로 쓰는 리눅스 서버가 있어 Build를 맡겨 보았지만 WSL만큼 편리할 수는 없었다.
특히나 저전력 서버이다 보니 상시 구동 중인 IoT 프로그램들과 자원을 나눠먹기 어려웠다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># WSL 설정: on Bash Shell</span>

<span class="nb">sudo </span>apt-get update <span class="nt">-y</span> <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt-get upgrade <span class="nt">-y</span>
<span class="c"># 시간이 오래 걸리는 작업이므로 powershell에서 wsl --export Ubuntu Ubuntu.tar로 백업해두는 것이 좋다.</span>

<span class="nb">sudo </span>apt <span class="nb">install </span>ruby-bundler ruby2.7-dev build-essential dh-autoreconf zlib1g-dev libffi-dev libssl-dev
<span class="nb">cd </span>REPOSITORY_PATH
bundle <span class="nb">install</span>
</code></pre></div></div>

<h2 id="배포하기">배포하기</h2>

<p>4~5년 전쯤엔 3rd-party 플러그인을 쓰려면 Travis-CI나 Netlify을 썼었다.
지금은 GitHub Actions으로 GitHub 내에서 3rd-party 플러그인도 이용하여 배포까지 할 수 있다.
이 웹사이트에도 간단한 플러그인을 작성해서 적용하고 있다.</p>

<p><a href="https://jekyllrb.com/docs/continuous-integration/github-actions/#setting-up-the-action">Jekyll 공식문서 예제</a>를 조금 변형해서, 
<a href="https://github.com/jihunroh/jihunroh.github.io/blob/main/.github/workflows/jekyll.yml">Workflow를 만들었다.</a>
<code class="language-plaintext highlighter-rouge">main</code> branch가 Workflow를 거친 후 나온 결과물은 <code class="language-plaintext highlighter-rouge">gh-pages</code> branch에 저장된다.
<code class="language-plaintext highlighter-rouge">gh-pages</code> branch는 Github Pages의 전통적인 기능에 따라 <code class="language-plaintext highlighter-rouge">https://jihunroh.github.io</code>에 결과물을 게시한다.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s">Build and deploy Jekyll site to GitHub Pages</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">main"</span> <span class="pi">]</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>

    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Cache gems</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/cache@v3</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">path</span><span class="pi">:</span> <span class="s">vendor/bundle</span>
        <span class="na">key</span><span class="pi">:</span> <span class="s">${{ runner.os }}-gems-${{ hashFiles('**/Gemfile') }}</span>
        <span class="na">restore-keys</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">${{ runner.os }}-gems-</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build &amp; Deploy to GitHub Pages</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">helaili/jekyll-action@v2</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">target_branch</span><span class="pi">:</span> <span class="s">gh-pages</span>
        <span class="na">target_path</span><span class="pi">:</span> <span class="s">/</span>
        <span class="na">token</span><span class="pi">:</span> <span class="s">${{ secrets.GH_TOKEN }}</span>
</code></pre></div></div>

<p>오랜 고질병처럼 글쓰기보단 글쓰는 프로그램에 몰두하게 된다.
2022년 하반기 목표가 일이건, 공부건 <code class="language-plaintext highlighter-rouge">하는 모든 일을 여과없이 기록</code>하는 건데 도움이 될 수도?</p>]]></content><author><name>노지훈</name></author><category term="Jekyll" /><summary type="html"><![CDATA[이 웹사이트는 Ruby 기반인 Jekyll로 만들었다. 개발자들이 많이 써온 프로그램인데, 2014년부터 써왔더니 나도 제법 쓸줄 안다. next.js 같은 더 현대적인 프로그램들이 각광받는 요즘에도, 오히려 투박해서 매력적인 프로그램이다.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jihunroh.github.io/assets/images/2022/continuous_deployment.webp" /><media:content medium="image" url="https://jihunroh.github.io/assets/images/2022/continuous_deployment.webp" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">탄소중립을 위한 행동은 왜 어려울까</title><link href="https://jihunroh.github.io/2021/10/04/%ED%83%84%EC%86%8C%EC%A4%91%EB%A6%BD%EC%9D%84-%EC%9C%84%ED%95%9C-%ED%96%89%EB%8F%99%EC%9D%80-%EC%99%9C-%EC%96%B4%EB%A0%A4%EC%9A%B8%EA%B9%8C/" rel="alternate" type="text/html" title="탄소중립을 위한 행동은 왜 어려울까" /><published>2021-10-04T00:00:00-05:00</published><updated>2021-10-04T00:00:00-05:00</updated><id>https://jihunroh.github.io/2021/10/04/%ED%83%84%EC%86%8C%EC%A4%91%EB%A6%BD%EC%9D%84%20%EC%9C%84%ED%95%9C%20%ED%96%89%EB%8F%99%EC%9D%80%20%EC%99%9C%20%EC%96%B4%EB%A0%A4%EC%9A%B8%EA%B9%8C</id><content type="html" xml:base="https://jihunroh.github.io/2021/10/04/%ED%83%84%EC%86%8C%EC%A4%91%EB%A6%BD%EC%9D%84-%EC%9C%84%ED%95%9C-%ED%96%89%EB%8F%99%EC%9D%80-%EC%99%9C-%EC%96%B4%EB%A0%A4%EC%9A%B8%EA%B9%8C/"><![CDATA[<p>나는 1년 전부터 바닷물고기를 키우고 있다. 야밤에 집안 조명들을 모두 끈 어둠 속에서 심연의 바다 한 조각을 바라보고 있으면 영롱하기 그지 없다.
이 취미는 요즘 내 업무분야인 ‘탄소중립’과도 밀접한 관련이 있는데, 어항이 본질적으로 ‘해양생태계의 질소순환 과정’을 좁은 공간 안에 구겨넣은 미니어쳐이기 때문이다.</p>

<p>어항에 투여된 물고기 사료는 질소를 품은 유기물이라서, 물고기, 박테리아의 소화 과정에서 암모니아 및 아질산염을 거쳐, 종국적으로는 질산염이 되어 어항에 누적된다.
본래 해양 생태계에서는 해조류가 광합성을 하며 질산염을 소모하여 질산염의 균형(이른바 질소순환 과정)을 이루는데, 그렇다고 어항에서 미역을 키울 수는 없는 노릇이다.
누적된 질산염은 물고기 건강에 만성적인 악영향을 주기 때문에, 주기적으로 깨끗한 물로 갈아주거나 질산염을 질소분자로 변환하는 약품을 투여해야 한다.</p>

<p><img src="/assets/images/2021/10/aquarium.jpg" alt="우리집 해수어항" /></p>

<p><a href="https://microbewiki.kenyon.edu/index.php/Nitrosococcus_oceani"><img src="/assets/images/2020/08/marine-nitrification.jpg" alt="바다에서의 질소 순환 과정" /></a></p>

<p>탄소중립의 난해함은 어항 관리의 그것과 닮았다.
지구(어항)의 탄소(질산염) 항상성을 깨뜨리고 누적시키는 원인(사료 급여)은 물론, 해결법(물갈이, 약품 투여)까지 공히 알려져는 있는데, 대체 탄소(질산염)는 눈에 쉽게 보이질 않아 얼만큼 행동해야 할지를 모르겠다.
노력에는 돈과 시간이 들기 때문에 막연하게 최대한의 노력을 하고 싶지는 않은 것이다.</p>

<p><a href="https://www.bbc.com/future/article/20190304-human-evolution-means-we-can-tackle-climate-change">영국의 국제이슈 기고가 Matthew Wilburn King은 우리가 기후행동을 꺼려하는 이유를 짚는다</a>.
우리 인류의 뇌에는 수백만년에 걸쳐 여러 인지 편향이 각인되었는데, 기후행동은 미래의 가치/비용에 대한 과소평가, 방관자 효과, 매몰비용 오류 등과 엮여 실행하지 어렵다는 것이다.
이 인지 편향들은 매우 강렬하다고 알려져 있어서, 다시 말하면 우리는 기후변화의 원인, 대응 필요성을 이해할 수는 있어도, 미래를 위한 일을 하는 데에는 좀처럼 성공하지 못한다. 소설가 김훈은 “밥벌이보다 숭고한 일은 없다”고 말했다. 이번달 나올 월급과 떼일 세금을 두고서는 “30년 후의 일인데 노력을 벌써부터 많이 해야하나<code class="language-plaintext highlighter-rouge">미래 과소평가</code>, 더 노력할 사람들이 많은데 내가 할 필요가 있을까?<code class="language-plaintext highlighter-rouge">방관자 효과</code>, 내연기관에 인류가 쏟은 돈이 얼만데 전기/수소차를 쓰라고?<code class="language-plaintext highlighter-rouge">매몰비용 오류</code>” 같은 생각이 아주 직관적인 접근이 되는 것이다.</p>

<p>기후환경 활동가들은 이러한 인지편향을 잘 이해하고 있는지, 사람들에게 강렬한 인상을 남기는 것이 해법이라고 생각하는 것 같다.
스웨덴의 만 16세 환경운동가 Greta Thunberg는 2019년 UN기후행동 정상회의 연단에서 “여러분은 헛된 말로 저의 꿈을 빼앗았습니다.
여러분이 할 수 있는 이야기는 전부 돈과 끝없는 경제성장의 신화 뿐입니다.
어떻게 그럴 수 있습니까?“라고 울먹이며 사람들의 큰 경각심을 불러일으켰다.
지구 온난화를 논할 때는 어김없이 작은 얼음 조각 위의 북극곰이 출연하고, 자원 재활용을 논할 때에는 폐플라스틱을 잔뜩 먹은 거북이가 등장한다.
얻는 기쁨보다 잃는 슬픔에 더 큰 의미를 두는 것이 인류의 오랜 부정 편향이다.
<a href="https://www.etnews.com/20140716000244">산업계가 2015년 시행될 온실가스배출권거래제를 두고 매년 30조원의 제조업 매출 감소를 겪게될 것이라고 경고한 점도 비슷한 전략이다</a>.
그야말로 편향을 전략적으로 이용하는 프레임 전투다.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/u9KxE4Kv9A8" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<p><img src="/assets/images/2021/10/polar_bear.jpg" alt="빙산조각 위의 북극곰" /></p>

<p>사람들이 더욱 체감하게 하기 위해, 해양에서 국소적으로 일어났던 ‘지구온난화’는 전지구적인 ‘기후변화’로, 중립적 의미의 ‘기후변화’는 다시 부정적 의미의 ‘기후위기’로 이슈 키워드가 변화해 가고 있다.
변화양상 속에서도 기후환경계와 경제산업계 간의 간극은 결코 좁혀지지 않을 것 같다.
요즘 나는 파리협약에 따라 당사국이 제출해야 하는 국가온실가스 감축목표(NDC)의 상향을 위해, 관계부처, 탄소중립위원회 등과 협의 중인데, 어느누구 간에는 서로 대화가 곤란할 정도의 치열한 감정싸움이 있다.</p>

<p>국토교통부는 탄소중립을 위한 건물의 에너지성능 향상, 전기/수소차 전환 가속화 등에서 과업을 설정하고자 노력 중이다.
나는 작년말 미래전략일자리담당관에서 탄소중립을 업무를 맡으면서 가졌던 뜨거운 지적 호기심을 기억한다.
하지만 업무과정에서 마주친 기후환경의 언어에는 잘 익숙해지지 못했다.
이 날선 프레임 전투 중에서, 쪽방촌에 연탄이 아닌 태양광패널 나눔봉사가 이뤄질 풍경,
화석연료의 불맛이 흠뻑 스민 옛날짬뽕을 그리워하는 모습,
쏟아지는 전기차 폐배터리로 골머리를 앓을 정부의 입장 등을 상상하며 유머를 찾는다.
이 모든 생각이 2021년 이 시대라는 우물 안에 살고 있기 때문에 갖게되는 아집일 수도 있기에, 머리쓰기보다 묵묵히 손부터 움직이려고 한다.</p>]]></content><author><name>노지훈</name></author><category term="탄소중립" /><summary type="html"><![CDATA[나는 1년 전부터 바닷물고기를 키우고 있다. 야밤에 집안 조명들을 모두 끈 어둠 속에서 심연의 바다 한 조각을 바라보고 있으면 영롱하기 그지 없다. 이 취미는 요즘 내 업무분야인 ‘탄소중립’과도 밀접한 관련이 있는데, 어항이 본질적으로 ‘해양생태계의 질소순환 과정’을 좁은 공간 안에 구겨넣은 미니어쳐이기 때문이다.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jihunroh.github.io/assets/images/covers/20211004.webp" /><media:content medium="image" url="https://jihunroh.github.io/assets/images/covers/20211004.webp" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">모든 주식의 주가가 한 계단(tick) 오른다면 어떤 주식을 사야할까?</title><link href="https://jihunroh.github.io/2021/03/21/%EB%AA%A8%EB%93%A0-%EC%A3%BC%EC%8B%9D%EC%9D%98-%EC%A3%BC%EA%B0%80%EA%B0%80-%ED%95%9C-%EA%B3%84%EB%8B%A8(tick)-%EC%98%A4%EB%A5%B8%EB%8B%A4%EB%A9%B4-%EC%96%B4%EB%96%A4-%EC%A3%BC%EC%8B%9D%EC%9D%84-%EC%82%AC%EC%95%BC%ED%95%A0%EA%B9%8C/" rel="alternate" type="text/html" title="모든 주식의 주가가 한 계단(tick) 오른다면 어떤 주식을 사야할까?" /><published>2021-03-21T00:00:00-05:00</published><updated>2021-03-21T00:00:00-05:00</updated><id>https://jihunroh.github.io/2021/03/21/%EB%AA%A8%EB%93%A0%20%EC%A3%BC%EC%8B%9D%EC%9D%98%20%EC%A3%BC%EA%B0%80%EA%B0%80%20%ED%95%9C%20%EA%B3%84%EB%8B%A8(tick)%20%EC%98%A4%EB%A5%B8%EB%8B%A4%EB%A9%B4%20%EC%96%B4%EB%96%A4%20%EC%A3%BC%EC%8B%9D%EC%9D%84%20%EC%82%AC%EC%95%BC%ED%95%A0%EA%B9%8C</id><content type="html" xml:base="https://jihunroh.github.io/2021/03/21/%EB%AA%A8%EB%93%A0-%EC%A3%BC%EC%8B%9D%EC%9D%98-%EC%A3%BC%EA%B0%80%EA%B0%80-%ED%95%9C-%EA%B3%84%EB%8B%A8(tick)-%EC%98%A4%EB%A5%B8%EB%8B%A4%EB%A9%B4-%EC%96%B4%EB%96%A4-%EC%A3%BC%EC%8B%9D%EC%9D%84-%EC%82%AC%EC%95%BC%ED%95%A0%EA%B9%8C/"><![CDATA[<p>스캘핑과 스윙의 중간 어느 지점에서(?) 놀고 있다.</p>

<p>하루 내에 호가 단위(tick) 한단계 높여 실현하는 경우도 있고,
며칠을 두고 서너 단위를 높여 실현하기도 한다.</p>

<p>그래서 거래량이 많고(주문이 잘 체결되고), 주가에 비해(많이 살 수 있고) 호가 단위(tick)가 상대적으로 큰(많이 이득을 주는) 주식을 좋아한다.
직감이든 우연이든 <code class="language-plaintext highlighter-rouge">SK하이닉스</code>가 그런 주식이라 생각했는데, 맞는 생각인지 확인해봤다.</p>

<p>질문을 다시 구성한다면 “<strong>매수할 주식의 주가가 한 계단(tick) 오른다면 어떤 주식을 사야할까?</strong>”</p>

<h2 id="이익-계산">이익 계산</h2>

<p>나는 현금 $M$을 갖고 있고, 주가가 $p$, 호가 단위(tick)가 $\Delta p$인 주식을 사려한다.
현금을 전부 써서 주식을 매수한다면, 주식은 $ M / p $주만큼 살 수 있을 것이다.
$M$이 $p$에 비하여 상대적으로 크다면 잔금을 무시할 수 있을 정도로 미미해진다.</p>

<p>이 주식을 매도가격 $p + \Delta p$에 판다.
증권거래세, 증권사수수료를 고려하면 수익/지출은 다음과 같다.</p>

<h3 id="매수-시-지출">매수 시 지출</h3>

<ol>
  <li>$ 매수금액 = 매입가격 \times 주식수  = p \times \frac{M}{p} = M $</li>
  <li>$ 매수수수료 = 매수금액 \times 수수료율 = M \times 0.015\% $</li>
</ol>

<h3 id="매도-시-수익">매도 시 수익</h3>

<ol>
  <li>$ 매도금액 = 매도가격 \times 주식수 = (p + \Delta p) \times \frac{M}{p} $</li>
  <li>$ 매도수수료 = 매도금액 \times 수수료율 = (p + \Delta p) \times \frac{M}{p} \times 0.015\% $</li>
  <li>$ 증권거래세 = 매도금액 \times 증권거래세율 = (p + \Delta p) \times \frac{M}{p} \times 0.25\% $</li>
</ol>

<h3 id="이익">이익</h3>

<p>이익 $\Pi$는 다음으로 정리된다. 종자돈 $M$이 클 수록, 주가 $p$는 낮을 수록, 호가 단위 $\Delta p$는 클 수록 커진다.</p>

\[\Pi = ( \frac{\Delta p}{p} \cdot  99.735\% - 0.28\% ) M\]

<p>예를 들어, 현재 13만8,000원인 <code class="language-plaintext highlighter-rouge">SK하이닉스</code>를 1,000만원으로 전부 매수하고 13만8,500원에 판다면, 이득은 8,136원을 얻는다.</p>

<p>이득을 얻으려면 $ \frac{\Delta p}{p} \cdot  99.735\% &gt; 0.28\% $ 이어야 한다.</p>

<p>이걸 좀 더 보기 쉽게 역수로 정리하면 다음과 같다.</p>

\[\frac{p}{\Delta p} &lt; 356.2\]

<p>이 조건을 충족하는 주식은 한 단위만 올라도 이득이고, 충족하지 못하는 주식은 손실이다.</p>

<h2 id="종목-비교">종목 비교</h2>

<p>이 조건을 충족하는 주식은 무엇이 있을까? Python에서 <a href="https://github.com/sharebook-kr/pykrx"><code class="language-plaintext highlighter-rouge">pykrx</code></a> 라이브러리를 이용했다. <strong>2021년 3월 19일 기준으로 KOSPI만 고려한다.</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pykrx</span> <span class="kn">import</span> <span class="n">stock</span>

<span class="k">def</span> <span class="nf">get_ticksize</span><span class="p">(</span><span class="n">price</span><span class="p">):</span>

  <span class="k">if</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
    <span class="n">ticksize</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="k">elif</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">:</span>
    <span class="n">ticksize</span> <span class="o">=</span> <span class="mi">5</span>
  <span class="k">elif</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">:</span>
    <span class="n">ticksize</span> <span class="o">=</span> <span class="mi">10</span>
  <span class="k">elif</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="mi">50000</span><span class="p">:</span>
    <span class="n">ticksize</span> <span class="o">=</span> <span class="mi">50</span>
  <span class="k">elif</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">:</span>
    <span class="n">ticksize</span> <span class="o">=</span> <span class="mi">100</span>
  <span class="k">elif</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="mi">500000</span><span class="p">:</span>
    <span class="n">ticksize</span> <span class="o">=</span> <span class="mi">500</span>
  <span class="k">elif</span> <span class="n">price</span> <span class="o">&gt;=</span> <span class="mi">500000</span><span class="p">:</span>
    <span class="n">ticksize</span> <span class="o">=</span> <span class="mi">1000</span>
  <span class="k">return</span> <span class="n">ticksize</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">stock</span><span class="p">.</span><span class="n">get_market_ohlcv_by_ticker</span><span class="p">(</span><span class="s">"20210319"</span><span class="p">)</span>

<span class="n">df</span><span class="p">[</span><span class="s">'종목명'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">index</span>
<span class="n">df</span><span class="p">[</span><span class="s">'종목명'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'종목명'</span><span class="p">].</span><span class="n">transform</span><span class="p">(</span><span class="n">stock</span><span class="p">.</span><span class="n">get_market_ticker_name</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s">'호가단위'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'종가'</span><span class="p">].</span><span class="n">transform</span><span class="p">(</span><span class="n">get_ticksize</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s">'p배율'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'종가'</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s">'호가단위'</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s">'거래대금'</span><span class="p">,</span> <span class="n">ascending</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
<span class="n">df</span><span class="p">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s">'result.xlsx'</span><span class="p">)</span>
</code></pre></div></div>

<p>결과를 엑셀로 잘 정리해 거래대금 순서로 30위까지 나열한다.</p>

<p><img src="/assets/images/2021/03/stock-01.jpg" alt="종목 비교" /></p>

<h2 id="결론">결론</h2>

<p><code class="language-plaintext highlighter-rouge">SK 하이닉스</code> 만세!!!다. <code class="language-plaintext highlighter-rouge">SK 바이오사이언스</code>가 갖 상장해서 이상점인 걸 감안하면, <strong>내 거래 스타일에서 <code class="language-plaintext highlighter-rouge">SK 하이닉스</code>만큼 좋은 주식이 안보인다.</strong></p>

<p>물론, 당연한 얘기(disclaimer)지만 이 지표만 절대적으로 볼 수는 없다.
호가단위가 작더라도 장 중에 변동성이 더 큰 주식이 더 좋을 수 있다.</p>

<p>예를 들어 모든 변수를 다 고정하고,
SK하이닉스가 1단위 움직일 때 삼성전자가 3단위로 동행한다고 하면,
<code class="language-plaintext highlighter-rouge">삼성전자</code>($\frac{p}{\Delta p} \div 3 = 273$)가 <code class="language-plaintext highlighter-rouge">SK하이닉스</code>($\frac{p}{\Delta p} = 276$)보다 미미하게나마 더 큰 이득을 본다.</p>

<p>2021년 3월 19일 기준의 결과이므로, 한달 후에 다시 재산출해보려 한다.</p>]]></content><author><name>노지훈</name></author><category term="주식" /><summary type="html"><![CDATA[스캘핑과 스윙의 중간 어느 지점에서(?) 놀고 있다.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jihunroh.github.io/assets/images/2021/03/stock-01.jpg" /><media:content medium="image" url="https://jihunroh.github.io/assets/images/2021/03/stock-01.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">월패드 원격제어를 위한 RS485 패킷 분석 준비</title><link href="https://jihunroh.github.io/2020/10/03/%EC%9B%94%ED%8C%A8%EB%93%9C-%EC%9B%90%EA%B2%A9%EC%A0%9C%EC%96%B4%EB%A5%BC-%EC%9C%84%ED%95%9C-RS485-%ED%8C%A8%ED%82%B7-%EB%B6%84%EC%84%9D-%EC%A4%80%EB%B9%84/" rel="alternate" type="text/html" title="월패드 원격제어를 위한 RS485 패킷 분석 준비" /><published>2020-10-03T00:00:00-05:00</published><updated>2020-10-03T00:00:00-05:00</updated><id>https://jihunroh.github.io/2020/10/03/%EC%9B%94%ED%8C%A8%EB%93%9C%20%EC%9B%90%EA%B2%A9%EC%A0%9C%EC%96%B4%EB%A5%BC%20%EC%9C%84%ED%95%9C%20RS485%20%ED%8C%A8%ED%82%B7%20%EB%B6%84%EC%84%9D%20%EC%A4%80%EB%B9%84</id><content type="html" xml:base="https://jihunroh.github.io/2020/10/03/%EC%9B%94%ED%8C%A8%EB%93%9C-%EC%9B%90%EA%B2%A9%EC%A0%9C%EC%96%B4%EB%A5%BC-%EC%9C%84%ED%95%9C-RS485-%ED%8C%A8%ED%82%B7-%EB%B6%84%EC%84%9D-%EC%A4%80%EB%B9%84/"><![CDATA[<p>Home Assistant 등 IoT 플랫폼에서 월패드를 제어할 수 있다면,
월패드에서 제어가능한 조명, 난방, 환기 등 기기를 IoT 플랫폼에서 간접적으로 제어할 수 있다.</p>

<p>월패드는 RS485 직렬통신을 주로 이용한다. 연결하는 방법은 의외로? 간단하다.
<a href="http://www.hi-flying.com/elfin-ew10-elfin-ew11">Elfin EW11</a>은 RS485 선에 연결하여,
오가는 패킷을 듣고, 원하는 패킷을 흘려준다. RS485 신호를 TCP 소켓, MQTT 등 다양한 방식으로 변환해준다.</p>

<p>난 나비엔 UHN-1010을 쓰고 있다. 월패드 아래에 있는 나사를 뜯어 월패드를 조심스럽게 들어냈다. 가족들에겐 양해가 필요하다.🤦🏻‍♂️</p>

<p><img src="/assets/images/2020/10/wallpad-1.jpg" alt="월패드 개방과정" /></p>

<p>Elfin EW11의 <code class="language-plaintext highlighter-rouge">A</code>, <code class="language-plaintext highlighter-rouge">B</code> 단자는 신호가 오가고, <code class="language-plaintext highlighter-rouge">C</code>, <code class="language-plaintext highlighter-rouge">D</code> 단자는 전원이다.
월패드 내측 회로에 있는 단자들과 점퍼케이블을 통해 연결했다.</p>

<p><img src="/assets/images/2020/10/ew11-wiring.jpg" alt="Elfin EW11 Wiring" /></p>

<p><img src="/assets/images/2020/10/wallpad-2.jpg" alt="월패드에 EW11 연결" /></p>

<p>Elfin EW11의 Wi-Fi 설정을 마치고, 라우터의 DHCP 서버로 고정된 내부IP를 할당했다.
패킷을 TCP 서버에 방송하도록 설정했다. SerialPortMon에서 TCP 서버에 접속하니 패킷이 잘 보인다. <a href="https://blog.djjproject.com/646">더 자세한 설정 장법은 도정진님 블로그에서 확인할 수 있다.</a></p>

<p><img src="/assets/images/2020/10/serialportmon.jpg" alt="SerialPortMon" /></p>

<p>위 설치가 다 끝나면, 유념해야 할 두가지 요소가 있다.</p>

<p>① 이 패킷에 표준은 없는 것 같다. <a href="http://www.kashi.or.kr/NewsLetter/Vol.01/TTAK.KO-04.0083_R1.pdf">IoT 까페에서 안내해 준 한국정보통신기술협회의 표준 문서</a>가 있는데 <a href="http://www.tta.or.kr/data/ttas_view.jsp?totalSu=10474&amp;by=asc&amp;order=standard_no&amp;rn=1&amp;pk_num=TTAK.KO-04.0073/R3&amp;nowSu=2888">폐지된 기준으로 나온다.</a> 따라서 본인이 쓰는 월패드가 쓰는 패킷을 리버스엔지니어링해야 한다. 이 작업이 좀 고되다.</p>

<p><img src="/assets/images/2020/10/specification.jpg" alt="한국정보통신기술협회 표준문서" /></p>

<p>② 패킷 분석 뿐만 아니라 Home Assistant가 읽을 수 있도록 변환도 해야한다. Home Assistant는 워낙 확장이 많아 신호를 넘겨줄 방법이 다양할 것 같은데,
가장 흔한 방법이 MQTT일 것이다.</p>

<p><a href="https://github.com/jihunroh/homeassistant-addons/tree/master/wallpad">난 홈어시스턴트 코리아 저장소에 있는 코콤 월패드 프로그램을 수정해 ①과 ②를 해결하고 있다.</a> 월패드 때문에 별도의 프로그램을 쓰는 것이 좀 찝찝해서, EW11이 MQTT로 바로 패킷을 쏘도록 하고, Home Assistant가 패킷을 분석하는 방법이 가능한지도 알아보고 있다.</p>]]></content><author><name>노지훈</name></author><category term="IoT" /><summary type="html"><![CDATA[Home Assistant 등 IoT 플랫폼에서 월패드를 제어할 수 있다면, 월패드에서 제어가능한 조명, 난방, 환기 등 기기를 IoT 플랫폼에서 간접적으로 제어할 수 있다.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jihunroh.github.io/assets/images/2020/10/wallpad-2.jpg" /><media:content medium="image" url="https://jihunroh.github.io/assets/images/2020/10/wallpad-2.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">해수어항에서의 질소순환 과정</title><link href="https://jihunroh.github.io/2020/08/16/%ED%95%B4%EC%88%98%EC%96%B4%ED%95%AD%EC%97%90%EC%84%9C%EC%9D%98-%EC%A7%88%EC%86%8C%EC%88%9C%ED%99%98-%EA%B3%BC%EC%A0%95/" rel="alternate" type="text/html" title="해수어항에서의 질소순환 과정" /><published>2020-08-16T00:00:00-05:00</published><updated>2020-08-16T00:00:00-05:00</updated><id>https://jihunroh.github.io/2020/08/16/%ED%95%B4%EC%88%98%EC%96%B4%ED%95%AD%EC%97%90%EC%84%9C%EC%9D%98%20%EC%A7%88%EC%86%8C%EC%88%9C%ED%99%98%20%EA%B3%BC%EC%A0%95</id><content type="html" xml:base="https://jihunroh.github.io/2020/08/16/%ED%95%B4%EC%88%98%EC%96%B4%ED%95%AD%EC%97%90%EC%84%9C%EC%9D%98-%EC%A7%88%EC%86%8C%EC%88%9C%ED%99%98-%EA%B3%BC%EC%A0%95/"><![CDATA[<p>🐟물고기🐠 먹이는 인간 음식처럼 단백질, 탄수화물, 지방과 같은 탄소화합물로 구성된다.
탄소화합물을 구성하는 질소는 자연에서 질소 순환과정<sub>nitrogen cycle</sub>에 따라 순환한다.
유기물 → 암모니아<sub>NH<sub>3</sub></sub> → 아질산염 이온<sub>NH<sub>2</sub><sup>-</sup></sub> → 질산염 이온<sub>NH<sub>3</sub><sup>-</sup></sub>으로 분해되는 질화 과정<sub>nitrification</sub>,
질산염 이온이 질소분자로 환원되는 탈질화 과정<sub>denitrification</sub>이다.</p>

<p><a href="https://microbewiki.kenyon.edu/index.php/Nitrosococcus_oceani"><img src="/assets/images/2020/08/marine-nitrification.jpg" alt="바다에서의 질소 순환 과정" /></a></p>

<p>해수어항은 이 자연계의 순환과정을 어항 속에 구겨넣기 위한 부단한 고뇌의 연속이다.</p>

<h2 id="암모니아화-ammonification">암모니아화 <sub>ammonification</sub></h2>

<p>어항 내 먹이 잔여분, 물고기 배설물이나 사체 등 탄소화합물은은 자연스럽게 나타나는 찌꺼기다.
생육을 위해 탄소화합물을 섭취하는 <a href="https://ko.wikipedia.org/wiki/종속영양생물">종속영양세균</a><sub>heterotrophic bacteria</sub>이 암모니아 기체로 분해한다.</p>

<p>암모니아는 상온에서 본래 기체이지만, 물에 가수분해되어 암모늄 이온과 수산화 이온으로 분리된다.
<a href="https://blog.naver.com/PostView.nhn?blogId=daichung&amp;logNo=20017638890">PH가 높을 수록 암모늄 이온으로 더 쉽게 가수분해된다.</a></p>

<p>\[ NH_3+ H_2 O \longleftrightarrow NH_4^+ + OH^- \]</p>

<p>시중의 박테리아제는 대개 암모니아화를 하는 종속영양세균을 포함하고 있다.
종속영양세균은 매 15~20분마다 분열하여 근시간에 폭발적으로 증식한다.</p>

<p><img src="/assets/images/2020/08/fritzzyme_monster_460.jpg" alt="FritzZyme Monster 460은 종속영양 박테리아를 함유하고 있다." /></p>

<h2 id="질화-nitrification">질화 <sub>nitrification</sub></h2>

<p>암모늄 이온은 물고기에 치명적인 위험을 주기에 빠른 제거나 산화가 필요하다.
암모늄 이온은 <code class="language-plaintext highlighter-rouge">Nitrosococcus</code>에 의해 아질산염 이온으로 산화된다.
<code class="language-plaintext highlighter-rouge">Nitrosomonas</code>가 언급되는 경우가 있는데,
<a href="https://blog.naver.com/dart007/221677462823">해수에서도 서식한다는 설명이 있는 반면</a>,
<a href="https://youtu.be/sso191sYB-4?t=705">민물에서 서식한다는 지적도 있다.</a></p>

<p>\[ 2NH_4+ 3O_2 \longrightarrow 2NO_2^- + 4H^+ + 2H_2 O \]</p>

<p>아질산염 이온은 <code class="language-plaintext highlighter-rouge">Nitrococcus</code>, <code class="language-plaintext highlighter-rouge">Nitrospina</code>에 의해 질산염 이온으로 산화된다.
마찬가지로 <code class="language-plaintext highlighter-rouge">Nitrobacter</code>가 언급되는 경우가 있는데,
<a href="https://blog.naver.com/dart007/221677462823">해수에서도 서식한다는 설명이 있는 반면</a>,
<a href="https://youtu.be/sso191sYB-4?t=705">민물에서 서식한다는 지적이 있다.</a></p>

<p>\[ 2 NO_2^- +  O_2 \longrightarrow 2 NO_3 \]</p>

<p>여하간 <code class="language-plaintext highlighter-rouge">Nitrosococcus</code>와 <code class="language-plaintext highlighter-rouge">Nitrococcus</code>가 해수 내 질화과정의 핵심인 <strong>질화 세균</strong>인건 이견이 없다.
<a href="https://www.britannica.com/science/nitrifying-bacterium#ref237319">산소를 이용하기에 호기성이고</a>,
<a href="https://terms.naver.com/entry.nhn?docId=2699177&amp;cid=51610&amp;categoryId=51610">독립영양세균</a>으로서 유기화합물을 합성할 때 아질산, 질산염을 이용하는 것이다.</p>

<p>위 두 반응을 종합하면 질산화 과정은 산소를 소모하고 어항의 PH를 높일 것으로 보이는데,
어항의 용존산소량과 PH에 유의미한 수준인지는 잘 모르겠다.</p>

<p>\[ NH_4^+ + 2 O_2 \longrightarrow NO_3^- + H_2 O + 2 H^+ \]</p>

<p>종속영양세균에 비하여 독립영양세균은 증식하는데 시간이 필요하다. 번식에 24~36시간이 소요된다고 한다.</p>

<h2 id="탈질화-denitrification">탈질화 <sub>Denitrification</sub></h2>

<p><a href="https://blog.naver.com/dart007/221683393015">탈질화 세균은 종류가 아주 많고</a> 호기성/혐기성 여부도 다양하다.
<a href="https://en.wikipedia.org/wiki/Pseudomonas_aeruginosa">가령, <code class="language-plaintext highlighter-rouge">Psuedomonas</code> 속의 Pseudomonas aeruginosa은 혐기성인데</a>,
<a href="http://www.dbpia.co.kr/journal/articleDetail?nodeId=NODE02375177&amp;nodeId=NODE02375177&amp;language=ko_KR"><code class="language-plaintext highlighter-rouge">Stenotrophomonas</code> 속의 어떤 종은 호기 조건에서 질산염을 낮춘다</a>.</p>

<p>질산염을 적정 수준으로 관리하는 것이 해수어항에서 가장 어려운 문제이기도 하다.
알게 필터<sub>Algae Scrubber</sub>, 리퓨지움을 통해 수초나 조류가 질산염을 소모하도록 하는 방법,
두껍게 깔린 모래<sub>deep sand</sub> 안의 산소가 희박한 환경에서 혐기성세균을 이용하는 방법 등이 있다.
하지만 공간 제약 문제로 쉽지 않은 방식들이다.</p>

<p>이 외에 <a href="https://cafe.naver.com/seaaes/210749">모종의 세균이 속성작용<sub>diagenesis</sub>에 필요한 수준보다 산소가 부족한 경우 질산염을 이용하는 특성을 고려한 보드카 요법</a>이 있다.
보드카, 설탕 등 탄소화합물을 투여해 종속영양세균을 폭발적으로 번식시켜서 세균이 무기호흡하며 질산염을 소모하도록 하는 보드카 요법 등이 거론된다.</p>]]></content><author><name>노지훈</name></author><category term="Reef" /><summary type="html"><![CDATA[🐟물고기🐠 먹이는 인간 음식처럼 단백질, 탄수화물, 지방과 같은 탄소화합물로 구성된다. 탄소화합물을 구성하는 질소는 자연에서 질소 순환과정nitrogen cycle에 따라 순환한다. 유기물 → 암모니아NH3 → 아질산염 이온NH2- → 질산염 이온NH3-으로 분해되는 질화 과정nitrification, 질산염 이온이 질소분자로 환원되는 탈질화 과정denitrification이다.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://upload.wikimedia.org/wikipedia/commons/2/2b/Marine_nitrogen_cycle_under_future_ocean_acidification.jpg" /><media:content medium="image" url="https://upload.wikimedia.org/wikipedia/commons/2/2b/Marine_nitrogen_cycle_under_future_ocean_acidification.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">기계적으로 어항물 보충을 자동화하기</title><link href="https://jihunroh.github.io/2020/07/26/%EA%B8%B0%EA%B3%84%EC%A0%81%EC%9C%BC%EB%A1%9C-%EC%96%B4%ED%95%AD%EB%AC%BC-%EB%B3%B4%EC%B6%A9%EC%9D%84-%EC%9E%90%EB%8F%99%ED%99%94%ED%95%98%EA%B8%B0/" rel="alternate" type="text/html" title="기계적으로 어항물 보충을 자동화하기" /><published>2020-07-26T00:00:00-05:00</published><updated>2020-07-26T00:00:00-05:00</updated><id>https://jihunroh.github.io/2020/07/26/%EA%B8%B0%EA%B3%84%EC%A0%81%EC%9C%BC%EB%A1%9C%20%EC%96%B4%ED%95%AD%EB%AC%BC%20%EB%B3%B4%EC%B6%A9%EC%9D%84%20%EC%9E%90%EB%8F%99%ED%99%94%ED%95%98%EA%B8%B0</id><content type="html" xml:base="https://jihunroh.github.io/2020/07/26/%EA%B8%B0%EA%B3%84%EC%A0%81%EC%9C%BC%EB%A1%9C-%EC%96%B4%ED%95%AD%EB%AC%BC-%EB%B3%B4%EC%B6%A9%EC%9D%84-%EC%9E%90%EB%8F%99%ED%99%94%ED%95%98%EA%B8%B0/"><![CDATA[<p>해수어항을 곁에 두면 환수보다는 보충수통 채우는 데 손이 자주 간다.
내가 쓰는 어항은 물이 250L 들어가는데, 여름철이면 하루에 2L 가까이 자연 증발되나 보다.
보충수 탱크는 11L 정도인데 물을 1주일에 한번 채워줘야 한다.</p>

<p>이게 귀찮다. 환수야 어항 청소하는 맛에 하는데,
일상적으로 RO/DI 필터에서 초순수를 받아서 보충수 탱크에 채우는 것은 영 재미가 없다.
탱크를 채울 때 늘 물을 바닥에 흘리는 찜찜함은 덤.</p>

<p>근데 물 보충 자동화를 표방하는 기성품이 이미 있었다.
<code class="language-plaintext highlighter-rouge">1AQUA SmartATO</code>라는 제품이다.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/GPoZvEoIboM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<p>전자식 수위 센서로 감지한 물 부족분 만큼 동봉된 보충수 탱크에서 물을 뽑아온다.
사람들이 꽤 쓰는 제품임에도 단점은 꽤 있는데,</p>

<ol>
  <li>전기를 먹는다. 전기가 필요 없는 대안이 있다면 이건 단점.</li>
  <li>보충수 탱크가 자리를 차지한다.</li>
  <li>RO/DI 초순수를 미리 준비해놓고 보충수 탱크에 채워놔야 한다.</li>
</ol>

<p>물론, 이 보충수 탱크에 볼탑을 설치해서 초순수가 들어가도록 설계해 3번 단점은 보완할 수 있겠다만,
그럴바엔 본항이나 섬프항에 볼탑을 설치하고 보충수 탱크 없이 바로 RO/DI 필터에 연결하는게 낫겠다 싶었다.
전자식 수위 센서는 물리적으로 작동하는 볼탑으로 충분히 대체할 수 있다고 생각했다.
있어보이려고 그려본 순서도… 이게 바로 <strong>전기를 1W도 쓰지 않고, 공간도 절약될 뿐더러, 손도 가지 않는 방법이다.</strong></p>

<div class="mxgraph" style="max-width:100%;border:1px solid transparent;" data-mxgraph="{&quot;highlight&quot;:&quot;#0000ff&quot;,&quot;nav&quot;:true,&quot;resize&quot;:true,&quot;xml&quot;:&quot;&lt;mxfile host=\&quot;app.diagrams.net\&quot; modified=\&quot;2020-07-26T11:11:54.257Z\&quot; agent=\&quot;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36 Edg/84.0.522.44\&quot; etag=\&quot;-I10HFzU2W8Q9fe1zAYm\&quot; version=\&quot;13.5.3\&quot; type=\&quot;device\&quot;&gt;&lt;diagram id=\&quot;C5RBs43oDa-KdzZeNtuy\&quot; name=\&quot;Page-1\&quot;&gt;7Vtbe6M2EP0t+8Bj8oG4WDyC7WTTbreXbJvuIwYZ02ArxTiJ99dXEhJXgXFi7KRxXoKkQbc5mjkzyIo+Xj5fJ97D4hccoFgBavCs6BMFAA3YgPyjNdusxrLVrCJMooALFRW30Q/EK4XYJgrQuiKYYhyn0UO10serFfLTSp2XJPipKjbHcXXUBy9EjYpb34ubtXdRkC6yWghGRf1nFIULMbJm2VnL0hPCfCXrhRfgp1KVPlX0cYJxmj0tn8coppsn9uXuZnsXf7m3rn/6ff2v96f787evf11knV3t80q+hASt0sN2zZX76MUbvl98relWbGCCN6sA0U5URXcX6TImjxp5/Ael6ZYr3NukmFThJF3gEK+8+AvGD1xujlcpF9NoGa0ChyqWlGcx9u+zqqsojvkYpMTlISmt0wTf57qjHeSKoMKxN0Ox6/n3IZvoGMc4IU0rvEK0q4CAga+lmNy0qHWz9VK5Gl52bDaXW+NN4qMOOZ1j3ktC1NWflSOKHEWElyhNtuS9BMVeGj1WJ+fxMxHmcoXeyQNX/R4w0JswmE4U21RcQ5mOFQgVG5L2LzdXU/Lvliwm/dQBFKqkp0WUotsHj23OE7EtVfCUQUHW7Yaxt15zle7Q+JwgRahZAXpgIhgY+WulFghmumWJwfhE+RY+oiRFzy9QeVNFvBeDmwluJyEvPhVGRxOWZFEyOOK1g+vUkOjUVaChOMb5jB/2jFs9z7imdiJIvdQMYFdQJLxobzPAO/8NR2RlhQiez9dkanVM5XN4OcxMCczG1HQQpFG8udR60BooA95u3b1raL4V4I3kuHs3ILPkILOYf2KOypmwmpFC6alKkeeMFXfMKidUDFgx2SF3lpCnkD7RJseirUTYVRV7TB/I6zbkXVHgEvgCWqNfNY3mAi9nm/VuX1f1XgSOV94yiunmf0bxI0oj35N4RC+OwhUp+AQqKJEjkQwZrUJSsorSN4b8C6PpKefzOfB9macMrJllWjlgB3eO2qind4RDeceR1DtSzDDtOwwPFEgZEiwOJDg+056qZoFaU619auIDz8TnWMRHeI7dzKcFRIN7IKIMb1uSeKBvrCVdiENRg7MBalH1fvLkIZvBQd2hfeZcHadiRTb377xfUvhOC5emKE6ey42TLS+d4qxc2+nX+bV/8xh64d03pG78J++iJUgY/Kg0sF037bpVM9nZUvhbh2d9Yqk1S+7qPC3hWopjl/MTlAtC0qqxB42684IUNvlfkyMyf0+4oJMdn6mggI5ikxEd2kQYyZkLHpIL6uDUXFDTduDMYFFCP5xRMYORR1nAIQlZMggSLGqCclZxCQUuqTWfMhRC1gkz9J2c5kMS0hq8TP2IfLTdnlfQ9cevpKPJDUcS99tM065agoI0YlWpPH3LZjYpi1iluFEFbgYwY2/HmuQOscucmAOZE6m+d1mTPl6LqNKkqpRigEhC1pXt0oCUBzd6ScXcNFzuiHf2VDL0kVzJM2gapjqkkoFZUTKwTn2oJR/OWoNMCfst7XLBVwuK+r3c1sJXq6qs0ennKC11SUrfSy1Fh7Qg+jtaJrPLSO4kx91x5IVmNnAhO/vmK0m0gKXeYntEF9myGwS52RGsdgRG/Zj2QDlY6c5Lvid1AJ3DRorzo8ZlL0XUcRBUTx80vFJfBOUZVdGROVisJt1FWT61f0rifScchk3DtTrFC/VSVbVRTe2vg+U+2QFoXFqmYUAwMqEF1OpEdNu+tO2RqmmGbQBTfNbc3zB2DWJYZAtAL5zvmwdkA4PqaCAfrXO6u956dU5QegCbWe9XRBkZNaXn9oqGtW0RaT0YYaNk39H+3/zTODn/lKSA96OdjU1U2V8veybopVYmlznVlNPL3P1r+7n/Lpr7Smqwk5TCnhSiJWN7HAqh17ijYb+QQhg1NmvUwXsg09qYMOz+xFKXF2noQc0pkBCaD8laDnaYQN/TpGvSc32Eu5Gd8/5AlyP76rzhaDuSsqe7HSkHmezb0vkbaiXbc7Cjr/eNxXXQ8+i/xZtrnUs/X107zufK4U3XUe+udZ6Sj3Z57fC6Na2abo95eU2uW9lPMT7o7TX5VwwRdMrDzJN5LuuteK5mXEezZKW/an4qS9QVf7A6hZbgsT3mO7gDld39Pl/OeKcGt+5MT387w5B91+LoqIBjwqHgCppF3CyBF2+CHBy1z/wcHCb7Tu/QVifDkMVxSWkcFAOSBRRj1pFDdjjtSuFxs1pWPK9q0DGqL8LcYoc3LKMgYBZXhseqk2lR+KszrPWckAQWlgQW+mCwkPyuqQ0W7LhTNIyYjgEjWqqwAVAYp7FIkMNc7NNZ882043CqJ8Xi59qZgyp+9K5P/wM=&lt;/diagram&gt;&lt;/mxfile&gt;&quot;,&quot;toolbar&quot;:&quot;pages zoom layers lightbox&quot;,&quot;page&quot;:0}"></div>
<script type="text/javascript" src="https://app.diagrams.net/js/viewer-static.min.js"></script>

<p>위 알고리즘에 따라 간소화되도록 설계를 구상했다.
섬프항에 이미 볼탑이 설치되어 있어서 정수기 관을 꽂아 빼냈다.
섬프항 청소 좀 해야겠다.🤦‍♂️</p>

<p><img src="/assets/images/2020/07/20200726_190815.jpg" alt="섬프항에 설치한 볼탑" /></p>

<p>섬프항에서 나온 정수기 관을 이렇게 어항 뒤에서 냉장고 뒤로 돌려보내고,
종국적으론 RO/DI 필터가 있는 세탁실로 빼낼 방법에서 며칠 해맸다.</p>

<p><img src="/assets/images/2020/07/20200726_190945.jpg" alt="어항, 냉장고 배치" /></p>

<p>벽 두께가 60cm 정도 되고, 세탁실 쪽 벽은 콘크리트라서 겁이 많이 났다.
<a href="https://www.clien.net/service/board/kin/15140850">이곳</a> <a href="https://cafe.naver.com/seaaes/602845">저곳</a>에 물어보았더니,
현자들이 답해주었다. 종합하면,</p>

<ol>
  <li>벽 안쪽에 철근이나 수도관 등이 지나갈 수 있으니 뚫는 건 자제하라.</li>
  <li>그래도 뚫고 싶으면 긴 드릴비트를 활용해라.</li>
</ol>

<p>로 정리됐다. 하지 말라는 1번은 무시하고… 어쨌거나 해야 하니 2번으로…</p>

<p><img src="/assets/images/2020/07/20200726_190856.jpg" alt="벽을 뚫은 정수기관" /></p>

<p>결국엔 벽을 드릴로 뚫었다. 긴 드릴비트를 살까말까 장고 중이던 차에,
술김에 15cm 겨우 되는 드릴비트로 주방 벽과 세탁실 벽을 대강 위치 맞추어서 뚫었다.
옷걸이를 펴서 구멍 안에 낑겨넣으니 안에는 단열재 따위가 들었는지, 쑥쑥 잘 들어갔다.
정수기관을 통과시키는 데는 어려움이 좀 있었지만 결국 성공.
구멍에 호스관이 지나가고나서 남는 1mm 정도 되는 여유는 투명 실리콘을 쏘아 막았다.</p>

<p><img src="/assets/images/2020/07/20200726_191146.jpg" alt="주방 쪽 정수기관" /></p>

<p><img src="/assets/images/2020/07/20200726_190639.jpg" alt="세탁실 쪽 정수기관" /></p>

<p>그리고 세탁실 쪽 수도꼭지에 RO/DI 필터를 두었다.
수도꼭지에 세탁실 청소용 호스를 같이 쓸 수 있도록 16A용 기능성 어댑터 여럿를 활용했다.</p>

<p>RO/DI 필터는 항상 작동 중인데, 섬프항에 물이 비었을 때만 수압에 따라 물을 공급한다.
가끔 환수를 위한 초순수를 받을 수 있게 필터 출수구에는 T피팅으로 갈래를 쳐줬다.</p>

<p><img src="/assets/images/2020/07/20200726_190919.jpg" alt="RO/DI 필터" /></p>

<p>이렇게 쓴지 막 2주가 됐다. 물고기들, 어항 수위 등은 변화 없이, 어항은 생태계를 계속 유지하고 있다.
보충수 탱크가 사라져 섬프도 한결 단순해졌다. 빈 공간 덕분에 자동 양말필터를 설치할지 고민할 수 있게 됐다.</p>

<p><strong>이게 바로 자동화다.</strong> 👨‍🎓</p>]]></content><author><name>노지훈</name></author><category term="Reef" /><summary type="html"><![CDATA[해수어항을 곁에 두면 환수보다는 보충수통 채우는 데 손이 자주 간다. 내가 쓰는 어항은 물이 250L 들어가는데, 여름철이면 하루에 2L 가까이 자연 증발되나 보다. 보충수 탱크는 11L 정도인데 물을 1주일에 한번 채워줘야 한다.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jihunroh.github.io/assets/images/covers/20200726.jpg" /><media:content medium="image" url="https://jihunroh.github.io/assets/images/covers/20200726.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">라즈베리파이4에 Quad Sata KIT 입히기</title><link href="https://jihunroh.github.io/2020/05/31/%EB%9D%BC%EC%A6%88%EB%B2%A0%EB%A6%AC%ED%8C%8C%EC%9D%B44%EC%97%90-Quad-Sata-KIT-%EC%9E%85%ED%9E%88%EA%B8%B0/" rel="alternate" type="text/html" title="라즈베리파이4에 Quad Sata KIT 입히기" /><published>2020-05-31T00:00:00-05:00</published><updated>2020-05-31T00:00:00-05:00</updated><id>https://jihunroh.github.io/2020/05/31/%EB%9D%BC%EC%A6%88%EB%B2%A0%EB%A6%AC%ED%8C%8C%EC%9D%B44%EC%97%90%20Quad%20Sata%20KIT%20%EC%9E%85%ED%9E%88%EA%B8%B0</id><content type="html" xml:base="https://jihunroh.github.io/2020/05/31/%EB%9D%BC%EC%A6%88%EB%B2%A0%EB%A6%AC%ED%8C%8C%EC%9D%B44%EC%97%90-Quad-Sata-KIT-%EC%9E%85%ED%9E%88%EA%B8%B0/"><![CDATA[<p>단순 저장소로만 시놀로지 DS216J를 써온 터라, 큰 무리가 없겠거니 싶어 라즈베리파이4 기반으로 IoT 허브 + 자작 NAS를 만들었다.</p>

<p>숫자가 높을 수록 좋은거니깐?! 과감히 DS216J는 방출했다.</p>

<table>
  <thead>
    <tr>
      <th>구분</th>
      <th>시놀로지 DS216J</th>
      <th>라즈베리파이 4</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>CPU 아키텍쳐</td>
      <td>Marvell Armada 385</td>
      <td>ARM Cortex-A72</td>
    </tr>
    <tr>
      <td>CPU 코어 수</td>
      <td>2</td>
      <td>4</td>
    </tr>
    <tr>
      <td>CPU 클럭</td>
      <td>1.0 GHz</td>
      <td>1.5 GHz</td>
    </tr>
    <tr>
      <td>RAM</td>
      <td>DDR3 512MB</td>
      <td>LPDDR4 4GB</td>
    </tr>
  </tbody>
</table>

<h2 id="이렇게-이쁘다">이렇게 이쁘다</h2>

<p>성격이 급하니 완성품부터 올려본다.
사진은 이쁘게 나오고 싶어서, 주렁주렁 매달려있던 TI 안테나를 빼고 찍었다.</p>

<p><img src="/assets/images/2020/05/rasp4-nas-1.jpg" alt="라즈베리파이4 나스+허브 사진 1" /></p>

<p><img src="/assets/images/2020/05/rasp4-nas-2.jpg" alt="라즈베리파이4 나스+허브 사진 2" /></p>

<h2 id="장비에-돈이-많이-들어갔다">장비에 돈이 많이 들어갔다</h2>

<p>스토리지를 제외한 순수 NAS 용도(RASP4 + SD + QUAD SATA KIT)로만 30만원 정도 들었다.
시놀로지 저가 제품보다 싸게, 더 좋은 성능으로 하려는 건데 스스로를 기만한 느낌…</p>

<p>시놀로지 완성품처럼 NAS를 포장해줄 <a href="https://shop.allnetchina.cn/products/quad-sata-hat-case-for-raspberry-pi-4">QUAD SATA KIT</a>으로
SSD(SATA3 인터페이스)를 라즈베리파이 4에 마운트했다.</p>

<p>SD카드는 16GB를 사도 될뻔 했다. 문서, 음악 등 덩치파일들은 물려놓은 SSD에 옮겨놓은 덕도 있지만,
라즈비안에 이짓저짓을 다해놨는데도 SD카드 사용량은 4GB가 되지 않는다.</p>

<p>Elfin EW11 이하 제품들은 모두 IoT를 위한 장비들이다.</p>

<table>
  <thead>
    <tr>
      <th>기기</th>
      <th>가격</th>
      <th>설명</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>라즈베리파이 4</td>
      <td>82,500원</td>
      <td> </td>
    </tr>
    <tr>
      <td>SD카드 32GB</td>
      <td>23,000원</td>
      <td> </td>
    </tr>
    <tr>
      <td>SSD <a href="http://prod.danawa.com/info/?pcode=5834230">삼성 860 EVO 1TB</a></td>
      <td>207,540원</td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="https://shop.allnetchina.cn/products/quad-sata-hat-case-for-raspberry-pi-4">QUAD SATA KIT</a></td>
      <td>$115</td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="https://ko.aliexpress.com/item/32926395786.html?spm=a2g0s.9042311.0.0.3cb54c4doQKd6C">Elfin EW11</a></td>
      <td>$14.8</td>
      <td>RS485 Serial to WiFi Socket converter</td>
    </tr>
    <tr>
      <td><a href="http://www.ti.com/tool/LAUNCHXL-CC1352P#buy">TI LAUNCHXL-CC1352P-2</a></td>
      <td>$56.98</td>
      <td>ZigBee Coordinator</td>
    </tr>
    <tr>
      <td><a href="https://ko.aliexpress.com/item/32851970258.html?spm=a2g0s.9042311.0.0.3cb54c4doQKd6C">Dlenp 2.4 GHz 안테나</a></td>
      <td>$2.44</td>
      <td>CC1352P-2에 붙일 안테나</td>
    </tr>
    <tr>
      <td><a href="https://www.aliexpress.com/item/4000439492385.html?spm=a2g0s.9042311.0.0.40604c4de0n1iq">CC2531 + CC Debugger + 안테나</a></td>
      <td>$20.57</td>
      <td>ZigBee Coordinator</td>
    </tr>
  </tbody>
</table>

<h2 id="장비들은-어여-일해">장비들은 어여 일해!</h2>

<p>OS는 <a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian Lite</a>로 IOT 허브(Home Assistant), 광고 차단(Pi-Hole), 리버스 프록시(traefik) 등을 이용할 계획으로 세팅했다.
구체적인 설치 방법은 웹에 많으니 생략. 개략적인 내 설정방법은 <a href="https://gist.github.com/jihunroh/d93340e5eb70d2a03d2daaf21b73bc70">이 곳</a>에.</p>

<p><img src="/assets/images/2020/05/rome.png" alt="Rome Schema" /></p>

<h2 id="역시-잘-샀어-자화자찬">역시 잘 샀어. 자화자찬</h2>

<p>다른 장비야 워낙 세간에 잘 알려져 있어, QUAD SATA KIT의 사용감이 중요할 것 같다.
<a href="https://youtu.be/xz-AhmjiTu8">유튜브에 조립 방법이 잘 나와있는데 조립하는 재미는 덤이다.</a>
나사가 들어가기에 너무 뻑뻑함 등은 중국제이니 용서가 된다.</p>

<p>외모가 훌륭하다. 딴딴한 철제로 되어 있어 플라스틱 특유의 싼마이 느낌이 들지 않는다.
라즈베리파이4를 날것으로 꺼내놓고 쓰며 들었던 찝찝한 느낌도 해소됐다.</p>

<p>방열판을 달아놓았던 라즈베리파이4에 팬이 달리다보니, 방열판으로는 CPU 온도가 60도 넘어로 올라가곤 했는데 지금은 40도 중반으로 유지되고 있다.
팬 소음이 좀 있지만, 안보이는 곳에 숨겨놓아 신경쓰이는 수준은 아니다.</p>

<p>NAS의 종착지는 시놀로지라는 통념을 거부하며(?), 사서 고생하는 취미를 가진 분들께 권하고 싶다.</p>]]></content><author><name>노지훈</name></author><category term="IoT" /><category term="RaspberryPi" /><summary type="html"><![CDATA[단순 저장소로만 시놀로지 DS216J를 써온 터라, 큰 무리가 없겠거니 싶어 라즈베리파이4 기반으로 IoT 허브 + 자작 NAS를 만들었다.]]></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://jihunroh.github.io/assets/images/covers/20200531.jpg" /><media:content medium="image" url="https://jihunroh.github.io/assets/images/covers/20200531.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry></feed>